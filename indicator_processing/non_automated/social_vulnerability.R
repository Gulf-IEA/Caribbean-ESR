# Code to plot social vulnerability data for PR and USVI. Eventually, the data will be added to NOAA's social vulnerability indicators tool (https://www.st.nmfs.noaa.gov/data-and-tools/social-indicators/). But for now, we are using data emailed by Tarsila Seara on 4/10/24. 

# Last updated 6/14/2024 by Carissa Gervasi

# For the commercial fishing engagement and reliance indicators we are using maps that were previously generated. 

# The remaining indicators that will be plotted here are the environmental justice, economic, and gentrification pressure indicators.

# Load the data

rm(list = ls())

plot.new()
dev.off()

library(readr)
CSVI_2010 = read_csv("indicator_data/inputsToBeUpdatedAnnually/CaribCSVI_2010.csv", locale = locale(encoding = "UTF-8"))
CSVI_2020 = read_csv("indicator_data/inputsToBeUpdatedAnnually/CaribCSVI_2020.csv", locale = locale(encoding = "UTF-8"))


library(ggplot2)
library(dplyr)
library(tidyr)

CSVI_2010$Year <- 2010
CSVI_2020$Year <- 2020


# Combine both dataframes
df_combined <- bind_rows(CSVI_2010, CSVI_2020)

#remove columns for raw data
df_combined = df_combined[,-c(2:7)]


# Convert to long format for ggplot
df_long <- df_combined %>%
  pivot_longer(cols = ends_with("Cat"),
               names_to = "Indicator",
               values_to = "Score")

# Remove rows with NA values
df_long <- na.omit(df_long)

df_long$Community = as.character(df_long$Community)
df_long$Region = as.character(df_long$Region)
df_long$Year = as.factor(df_long$Year)
df_long$Indicator = as.character(df_long$Indicator)
df_long$Score = as.integer(df_long$Score)



# Rename and combine regions
df_long <- df_long %>%
  mutate(Region = recode(Region,
                         'STT' = 'St. Thomas & St. John',
                         'STJ' = 'St. Thomas & St. John',
                         'STX' = 'St. Croix',
                         'W' = 'Puerto Rico West',
                         'E' = 'Puerto Rico East'))

# Verify the changes
unique(df_long$Region)


# Rename indicators
df_long <- df_long %>%
  mutate(Indicator = recode(Indicator,
                         'PerDisCat' = 'Personal Disruption',
                         'PopComCat' = 'Pop Composition',
                         'PovertyCat' = 'Poverty',
                         'LabFrc_revCat' = 'Labor Force',
                         'HsChr_rev_Cat' = 'Housing Charac',
                         'RetMigCat' = 'Retiree Migration'))

unique(df_long$Indicator)


# Create Faceted Bar Plots for each region
regions <- unique(df_long$Region)

for (region in regions) {
  p <- ggplot(df_long %>% filter(Region == region), aes(x = Community, y = Score, fill = as.factor(Year))) +
    geom_bar(stat = "identity", position = "dodge") +
    facet_wrap(~ Indicator, scales = "free_y") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 5),
          axis.text.y = element_text(size = 10),
          strip.text = element_text(size = 10),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 10)) +
    labs(title = paste("Standardized Indicator Scores by Community & Year", region),
         x = "Community",
         y = "Score",
         fill = "Year")
  
  ggsave(paste0("indicator_plots/CSVI_plots/Faceted_Bar_Plot_", region, ".png"), plot = p, width = 12, height = 8)
}



# Create Line Plots for each region
for (region in regions) {
  p <- ggplot(df_long %>% filter(Region == region), aes(x = Year, y = Score, color = Community, group = Community)) +
    geom_line() +
    geom_point() +
    facet_wrap(~ Indicator, scales = "free_y") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
          axis.text.y = element_text(size = 10),
          strip.text = element_text(size = 10),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 10)) +
    labs(title = paste("Change in Standardized Indicator Scores Over Time by Community", region),
         x = "Year",
         y = "Score",
         color = "Community")
  
  ggsave(paste0("indicator_plots/CSVI_plots/Line_Plot_", region, ".png"), plot = p, width = 12, height = 8)
}




# Create Heatmaps for each region
for (region in regions) {
  p <- ggplot(df_long %>% filter(Region == region), aes(x = as.factor(Year), y = Community, fill = Score)) +
    geom_tile() +
    facet_wrap(~ Indicator, scales = "free_y") +
    scale_fill_gradient(low = "blue", high = "red") +
    theme_minimal() +
    theme(panel.background = element_rect(fill = "white", color = NA),
          plot.background = element_rect(fill = "white", color = NA),
          axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
          axis.text.y = element_text(size = 10),
          strip.text = element_text(size = 10),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 10)) +
    labs(title = paste("Heatmap of Standardized Indicator Scores by Community and Year", region),
         x = "Year",
         y = "Community",
         fill = "Score")
  
  ggsave(paste0("indicator_plots/CSVI_plots/Heatmap_", region, ".png"), plot = p, width = 12, height = 8, bg = "white")
}






# Create Box Plots for each region
for (region in regions) {
  p <- ggplot(df_long %>% filter(Region == region), aes(x = as.factor(Year), y = Score, fill = as.factor(Year))) +
    geom_boxplot() +
    facet_wrap(~ Indicator, scales = "free_y") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
          axis.text.y = element_text(size = 10),
          strip.text = element_text(size = 10),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 10)) +
    labs(title = paste("Distribution of Standardized Indicator Scores by Year", region),
         x = "Year",
         y = "Score",
         fill = "Year")
  
  ggsave(paste0("indicator_plots/CSVI_plots/Box_Plot_", region, ".png"), plot = p, width = 12, height = 8)
}


print("social indicators -- SUCCESSFULLY RUN")
